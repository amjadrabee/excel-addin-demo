/*! For license information please see 68494f468443b9ec6f52.js.LICENSE.txt */
function _regenerator(){var e,n,o="function"==typeof Symbol?Symbol:{},t=o.iterator||"@@iterator",r=o.toStringTag||"@@toStringTag";function a(o,t,r,a){var c=t&&t.prototype instanceof i?t:i,l=Object.create(c.prototype);return _regeneratorDefine2(l,"_invoke",function(o,t,r){var a,i,c,l=0,u=r||[],d=!1,f={p:0,n:0,v:e,a:g,f:g.bind(e,4),d:function(n,o){return a=n,i=0,c=e,f.n=o,s}};function g(o,t){for(i=o,c=t,n=0;!d&&l&&!r&&n<u.length;n++){var r,a=u[n],g=f.p,p=a[2];o>3?(r=p===t)&&(c=a[(i=a[4])?5:(i=3,3)],a[4]=a[5]=e):a[0]<=g&&((r=o<2&&g<a[1])?(i=0,f.v=t,f.n=a[1]):g<p&&(r=o<3||a[0]>t||t>p)&&(a[4]=o,a[5]=t,f.n=p,i=0))}if(r||o>1)return s;throw d=!0,t}return function(r,u,p){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&g(u,p),i=u,c=p;(n=i<2?e:c)||!d;){a||(i?i<3?(i>1&&(f.n=-1),g(i,c)):f.n=c:f.v=c);try{if(l=2,a){if(i||(r="next"),n=a[r]){if(!(n=n.call(a,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,i<2&&(i=0)}else 1===i&&(n=a.return)&&n.call(a),i<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),i=1);a=e}else if((n=(d=f.n<0)?c:o.call(t,f))!==s)break}catch(n){a=e,i=1,c=n}finally{l=1}}return{value:n,done:d}}}(o,r,a),!0),l}var s={};function i(){}function c(){}function l(){}n=Object.getPrototypeOf;var u=[][t]?n(n([][t]())):(_regeneratorDefine2(n={},t,function(){return this}),n),d=l.prototype=i.prototype=Object.create(u);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,_regeneratorDefine2(e,r,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=l,_regeneratorDefine2(d,"constructor",l),_regeneratorDefine2(l,"constructor",c),c.displayName="GeneratorFunction",_regeneratorDefine2(l,r,"GeneratorFunction"),_regeneratorDefine2(d),_regeneratorDefine2(d,r,"Generator"),_regeneratorDefine2(d,t,function(){return this}),_regeneratorDefine2(d,"toString",function(){return"[object Generator]"}),(_regenerator=function(){return{w:a,m:f}})()}function _regeneratorDefine2(e,n,o,t){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}_regeneratorDefine2=function(e,n,o,t){if(n)r?r(e,n,{value:o,enumerable:!t,configurable:!t,writable:!t}):e[n]=o;else{var a=function(n,o){_regeneratorDefine2(e,n,function(e){return this._invoke(n,o,e)})};a("next",0),a("throw",1),a("return",2)}},_regeneratorDefine2(e,n,o,t)}function asyncGeneratorStep(e,n,o,t,r,a,s){try{var i=e[a](s),c=i.value}catch(e){return void o(e)}i.done?n(c):Promise.resolve(c).then(t,r)}function _asyncToGenerator(e){return function(){var n=this,o=arguments;return new Promise(function(t,r){var a=e.apply(n,o);function s(e){asyncGeneratorStep(a,t,r,s,i,"next",e)}function i(e){asyncGeneratorStep(a,t,r,s,i,"throw",e)}s(void 0)})}}import{initializeApp,getApps,deleteApp}from"firebase/app";import{getFirestore,doc,getDoc,collection,addDoc}from"firebase/firestore";import{logoutRequestLocal,getAuthInstance,getDbInstance}from"../firebase-auth.js";var cloudConvertApiKey=null,authInstance=null,dbInstance=null;function ensureFirebaseAndConfig(){return _ensureFirebaseAndConfig.apply(this,arguments)}function _ensureFirebaseAndConfig(){return(_ensureFirebaseAndConfig=_asyncToGenerator(_regenerator().m(function e(){var n,o,t,r,a,s,i,c,l,u,d,f;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if((n=document.getElementById("status"))&&(n.textContent="üîÑ Initializing add-in..."),console.log("ensureFirebaseAndConfig started."),(t=getApps()).length>0&&(o=t.find(function(e){return"[DEFAULT]"===e.name}))&&(console.log("Default Firebase app already initialized."),authInstance||(authInstance=getAuthInstance(o)),dbInstance||(dbInstance=getDbInstance(o))),o){e.n=10;break}return console.log("No default Firebase app found. Initializing temporary Firebase app to fetch configs."),r=initializeApp({projectId:"excel-addin-auth"},"tmp"),a=getFirestore(r),e.p=1,console.log("Fetching Firebase config from Firestore..."),e.n=2,getDoc(doc(a,"config","firebase"));case 2:if((s=e.v).exists()){e.n=3;break}throw new Error("‚ùå Firebase config missing in Firestore.");case 3:return o=initializeApp(s.data()),authInstance=getAuthInstance(o),dbInstance=getDbInstance(o),console.log("Default Firebase app and instances initialized with fetched config."),console.log("Fetching CloudConvert API key from Firestore..."),e.n=4,getDoc(doc(a,"config","cloudconvert"));case 4:if((i=e.v).exists()&&i.data().key){e.n=5;break}throw new Error("‚ùå CloudConvert API key missing or empty in Firestore.");case 5:cloudConvertApiKey=i.data().key,console.log("CloudConvert API key successfully fetched and assigned."),e.n=7;break;case 6:throw e.p=6,d=e.v,console.error("Error during initial Firebase/config fetch:",d),n&&(n.textContent="‚ùå Add-in failed to load config: ".concat(d.message)),cloudConvertApiKey=null,d;case 7:return e.p=7,e.n=8,deleteApp(r);case 8:return console.log("Temporary Firebase app deleted."),e.f(7);case 9:e.n=18;break;case 10:if(cloudConvertApiKey){e.n=17;break}return console.log("Default Firebase app already existed, but CloudConvert API key not set. Attempting to fetch key."),e.p=11,c=getFirestore(o),e.n=12,getDoc(doc(c,"config","cloudconvert"));case 12:if(!(l=e.v).exists()||!l.data().key){e.n=13;break}cloudConvertApiKey=l.data().key,console.log("CloudConvert API key fetched from existing Firebase app."),e.n=14;break;case 13:throw console.warn("CloudConvert API key still missing/empty after re-fetch attempt from existing Firebase app."),new Error("CloudConvert API key not found in Firestore after re-fetch.");case 14:e.n=16;break;case 15:throw e.p=15,f=e.v,console.error("Error fetching CloudConvert key from existing Firebase app:",f),n&&(n.textContent="‚ùå CloudConvert key load failed: ".concat(f.message)),cloudConvertApiKey=null,f;case 16:e.n=18;break;case 17:console.log("CloudConvert API key already present.");case 18:if(cloudConvertApiKey){e.n=19;break}throw u="CloudConvert API key is critical for conversion and could not be loaded.",console.error(u),n&&(n.textContent="‚ùå ".concat(u)),new Error(u);case 19:n&&(n.textContent="‚úÖ Add-in ready.");case 20:return e.a(2)}},e,null,[[11,15],[1,6,7,9]])}))).apply(this,arguments)}function convertToPDF(){return _convertToPDF.apply(this,arguments)}function _convertToPDF(){return(_convertToPDF=_asyncToGenerator(_regenerator().m(function e(){var n,o,t,r,a,s,i,c,l,u,d,f,g,p,v,y,m,C;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(console.log("convertToPDF function called."),n=document.getElementById("uploadDocx"),o=document.getElementById("status"),t=n.files[0]){e.n=1;break}return o.textContent="‚ùå Select a .docx file.",console.warn("No file selected for conversion."),e.a(2);case 1:if(cloudConvertApiKey){e.n=2;break}return o.textContent="‚ùå CloudConvert API key not loaded. Cannot proceed with conversion.",console.error("CloudConvert API key is null or not fetched successfully. Check console for config errors."),e.a(2);case 2:return r=cloudConvertApiKey,e.p=3,o.textContent="üîÑ Creating conversion job‚Ä¶",console.log("Attempting to create CloudConvert job..."),e.n=4,fetch("https://api.cloudconvert.com/v2/jobs",{method:"POST",headers:{Authorization:"Bearer ".concat(r),"Content-Type":"application/json"},body:JSON.stringify({tasks:{upload:{operation:"import/upload"},convert:{operation:"convert",input:"upload",input_format:"docx",output_format:"pdf"},export:{operation:"export/url",input:"convert"}}})});case 4:if((a=e.v).ok){e.n=9;break}return s="CloudConvert API error: ".concat(a.status),e.p=5,e.n=6,a.json();case 6:(i=e.v)&&i.message?s+=" - ".concat(i.message):i&&i.errors&&i.errors.length>0?s+=" - ".concat(i.errors[0].message||"Unknown API error details"):s+=" - (Raw response: ".concat(JSON.stringify(i),")"),e.n=8;break;case 7:e.p=7,m=e.v,s+=" - (Failed to parse error response body: ".concat(m.message,")");case 8:throw new Error(s);case 9:return e.n=10,a.json();case 10:if(c=e.v,console.log("CloudConvert job created:",c),(l=Object.values(c.data.tasks).find(function(e){return"import/upload"===e.operation}))&&l.result&&l.result.form&&l.result.form.url){e.n=11;break}throw new Error("CloudConvert did not return expected upload task details.");case 11:for(d in o.textContent="üîÑ Uploading file‚Ä¶",console.log("Attempting to upload file to CloudConvert..."),u=new FormData,l.result.form.parameters)u.append(d,l.result.form.parameters[d]);return u.append("file",t),e.n=12,fetch(l.result.form.url,{method:"POST",body:u});case 12:if((f=e.v).ok){e.n=13;break}throw new Error("CloudConvert upload failed with status: ".concat(f.status));case 13:console.log("File uploaded successfully."),o.textContent="‚è≥ Converting‚Ä¶",console.log("Polling CloudConvert job status...");case 14:return e.n=15,fetch("https://api.cloudconvert.com/v2/jobs/".concat(c.data.id),{headers:{Authorization:"Bearer ".concat(r)}});case 15:return p=e.v,e.n=16,p.json();case 16:if(v=e.v,console.log("CloudConvert poll status:",v.data.status),"finished"!==v.data.status){e.n=17;break}return g=v.data.tasks.find(function(e){return"export"===e.name}),e.a(3,20);case 17:if("error"!==v.data.status){e.n=18;break}throw new Error("CloudConvert job failed: ".concat(v.data.message||"Unknown error during conversion."));case 18:return e.n=19,new Promise(function(e){return setTimeout(e,3e3)});case 19:e.n=14;break;case 20:if(g&&g.result&&g.result.files&&0!==g.result.files.length){e.n=21;break}throw new Error("CloudConvert did not return an exported file URL.");case 21:return y=g.result.files[0].url,o.innerHTML='‚úÖ Done! <a href="'.concat(y,'" target="_blank">Download PDF</a>'),console.log("Conversion successful, PDF URL:",y),e.n=22,logConversion(t.name,y,"success");case 22:e.n=24;break;case 23:return e.p=23,C=e.v,console.error("Conversion error:",C),o.textContent="‚ùå Conversion failed: ".concat(C.message||"See console for details."),e.n=24,logConversion(t?t.name:"N/A","N/A","failed",C.message||"Unknown error");case 24:return e.a(2)}},e,null,[[5,7],[3,23]])}))).apply(this,arguments)}function logConversion(e,n,o){return _logConversion.apply(this,arguments)}function _logConversion(){return _logConversion=_asyncToGenerator(_regenerator().m(function e(n,o,t){var r,a,s,i,c=arguments;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(r=c.length>3&&void 0!==c[3]?c[3]:null,dbInstance&&authInstance&&authInstance.currentUser){e.n=1;break}return console.warn("Firestore or Auth not initialized, or no user logged in. Cannot log conversion."),e.a(2);case 1:return a=authInstance.currentUser.uid,s={userId:a,fileName:n,downloadUrl:o,status:t,timestamp:new Date,errorMessage:r},e.p=2,e.n=3,addDoc(collection(dbInstance,"sessions",a,"conversion_history"),s);case 3:console.log("Conversion logged to Firestore:",s),e.n=5;break;case 4:e.p=4,i=e.v,console.error("Error logging conversion to Firestore:",i);case 5:return e.a(2)}},e,null,[[2,4]])})),_logConversion.apply(this,arguments)}function requestLogout(){return _requestLogout.apply(this,arguments)}function _requestLogout(){return(_requestLogout=_asyncToGenerator(_regenerator().m(function e(){var n,o,t;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return console.log("requestLogout function called."),n=localStorage.getItem("email")||"Unknown User",o=encodeURIComponent("Logout Request"),t=encodeURIComponent("".concat(n," requests logout from Excel Add‚Äëin.")),window.location.href="mailto:support@yourcompany.com?subject=".concat(o,"&body=").concat(t),e.n=1,logoutRequestLocal();case 1:console.log("logoutRequestLocal completed.");case 2:return e.a(2)}},e)}))).apply(this,arguments)}Office.onReady(_asyncToGenerator(_regenerator().m(function e(){var n,o,t,r;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return console.log("Office.onReady has fired. Starting config ensureance."),e.p=1,e.n=2,ensureFirebaseAndConfig();case 2:document.getElementById("main-ui").style.display="block",n=document.getElementById("convertBtn"),o=document.getElementById("requestLogout"),n&&(n.addEventListener("click",convertToPDF),console.log("Convert button event listener attached.")),o&&(o.addEventListener("click",requestLogout),console.log("Logout button event listener attached.")),e.n=4;break;case 3:e.p=3,r=e.v,console.error("Add-in failed to initialize:",r),(t=document.getElementById("status"))&&(t.textContent="‚ùå Initialization failed: ".concat(r.message||"Unknown error",". Check console.")),document.getElementById("main-ui").style.display="block";case 4:return e.a(2)}},e,null,[[1,3]])})));